@model IEnumerable<WebsiteE_Commerce.Data.HangHoa>

@{
    ViewData["Title"] = "Shop - Furni";
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Untree.co">
    <link rel="shortcut icon" href="~/favicon.png">
    <meta name="description" content="" />
    <meta name="keywords" content="bootstrap, furniture, shop" />

    <!-- Bootstrap CSS -->
    <link href="~/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="~/css/tiny-slider.css" rel="stylesheet">
    <link href="~/css/style.css" rel="stylesheet">
    <link href="~/css/search.css" rel="stylesheet">
    <title>@ViewData["Title"]</title>
    <style>
        /* CSS cho c√°c √¥ danh m·ª•c */
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-tab {
            padding: 8px 16px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #495057;
        }
        
        .category-tab:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }
        
        .category-tab.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        
        
        /* Hi·ªáu ·ª©ng chuy·ªÉn ti·∫øp cho s·∫£n ph·∫©m */
        #productList {
            transition: opacity 0.3s ease;
        }
        
        #productList.loading {
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <!-- Start Header/Navigation -->
    
    </nav>
    <!-- End Header/Navigation -->

    <!-- Start Hero Section -->
    <div class="hero">
        <div class="container">
            <div class="row justify-content-between">
                <div class="col-lg-5">
                    <div class="intro-excerpt">
                        <h1>Shop</h1>
                        <p></p>
                        <p>
                            <a href="#" class="btn btn-secondary me-2">Shop Now</a>
                            <a href="#" class="btn btn-white-outline">Explore</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Hero Section -->

    <!-- ===== THANH SEARCH ===== -->
    <div class="untree_co-section pt-5 pb-3">
        <div class="container">
            <div class="search-container">
                <div class="search-wrapper">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text"
                               class="search-input"
                               placeholder="Search "
                               id="searchInput"
                               autocomplete="off">
                        <button class="clear-btn" id="clearBtn">‚úï</button>
                        <button class="search-btn" id="searchBtn">Search</button>
                    </div>
                </div>

                <!-- Ph·∫ßn c√°c √¥ danh m·ª•c -->
                <div class="category-tabs-container mt-4">
                    <h5 class="mb-3">Category</h5>
                    <div class="category-tabs" id="categoryTabs">
                        <div class="category-tab active" data-category="">All</div>
                        @if (ViewBag.Categories != null)
                        {
                            @foreach (var category in ViewBag.Categories)
                            {
                                <div class="category-tab" data-category="@category.MaLoai">@category.TenLoai</div>
                            }
                        }
                    </div>
                </div>

                <!-- Ph·∫ßn s·∫Øp x·∫øp (gi·ªØ nguy√™n) -->
                <div class="filters mt-4">
                    <div class="filter-group">
                        <label class="filter-label">Sort</label>
                        <select id="priceSort">
                            <option value="">Defaust</option>
                            <option value="asc">Price: Low to High</option>
                            <option value="desc">Price: High to Low</option>
                            <option value="newest">Newest</option>
                        </select>
                    </div>
                </div>

                <!-- Dropdown g·ª£i √Ω t√¨m ki·∫øm -->
                <div class="suggestions" id="suggestions"></div>
                
                <!-- Loading spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i s·∫£n ph·∫©m...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- ===== K·∫æT TH√öC THANH SEARCH ===== -->

    <!-- Start Product Section -->
    <div class="untree_co-section product-section before-footer-section">
        <div class="container">
            <div class="row" id="productList">
                <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c t·∫£i b·∫±ng AJAX -->
                @await Html.PartialAsync("_ProductListPartial", Model)
            </div>
        </div>
    </div>
    <!-- End Product Section -->

    <!-- Start Footer Section -->
    <footer class="footer-section">
        <!-- ... (gi·ªØ nguy√™n footer) ... -->
    </footer>
    <!-- End Footer Section -->

    <script src="~/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/tiny-slider.js"></script>
    <script src="~/js/custom.js"></script>
    <script src="~/js/search.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Bi·∫øn to√†n c·ª•c
        let currentSearch = '';
        let currentCategory = '';
        let currentSort = '';
        
        // C√°c elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const categoryTabs = document.querySelectorAll('.category-tab');
        const priceSort = document.getElementById('priceSort');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const productList = document.getElementById('productList');
        const clearBtn = document.getElementById('clearBtn');
        
        // ===== 1. X·ª¨ L√ù SEARCH (AJAX) =====
        function handleSearch() {
            currentSearch = searchInput.value.trim();
            
            // C·∫≠p nh·∫≠t URL
            updateUrlParams();
            
            // Load s·∫£n ph·∫©m
            loadProducts();
        }
        
        // N√∫t search
        if (searchBtn) {
            searchBtn.addEventListener('click', handleSearch);
        }
        
        // Enter ƒë·ªÉ search
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
        }
        
        // ===== 2. X·ª¨ L√ù CATEGORY TABS =====
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                categoryTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // L·∫•y category
                currentCategory = this.getAttribute('data-category');
                
                // C·∫≠p nh·∫≠t URL v√† load s·∫£n ph·∫©m
                updateUrlParams();
                loadProducts();
            });
        });
        
        // ===== 3. X·ª¨ L√ù SORT =====
        if (priceSort) {
            priceSort.addEventListener('change', function() {
                currentSort = this.value;
                updateUrlParams();
                loadProducts();
            });
        }
        
        // ===== 4. H√ÄM LOAD S·∫¢N PH·∫®M (AJAX) =====
        function loadProducts() {
            productList.classList.add('loading');
            if (loadingSpinner) loadingSpinner.style.display = 'block';
            
            const params = new URLSearchParams();
            if (currentSearch) params.append('search', currentSearch);
            if (currentCategory) params.append('category', currentCategory);
            if (currentSort) params.append('sort', currentSort);
            
            // G·ªçi API t√≠ch h·ª£p search + sort
            fetch(`/Shop/SearchAndSort?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.text();
                })
                .then(html => {
                    productList.innerHTML = html;
                    productList.classList.remove('loading');
                    if (loadingSpinner) loadingSpinner.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    productList.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted fs-5">C√≥ l·ªói x·∫£y ra.</p></div>';
                    productList.classList.remove('loading');
                    if (loadingSpinner) loadingSpinner.style.display = 'none';
                });
        }
        
        // ===== 5. C·∫¨P NH·∫¨T URL PARAMS =====
        function updateUrlParams() {
            const params = new URLSearchParams();
            if (currentSearch) params.set('search', currentSearch);
            if (currentCategory) params.set('category', currentCategory);
            if (currentSort) params.set('sort', currentSort);
            
            const newUrl = `/Shop${params.toString() ? '?' + params.toString() : ''}`;
            window.history.pushState({}, '', newUrl);
        }
        
        // ===== 6. X·ª¨ L√ù N√öT CLEAR =====
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                currentSearch = '';
                clearBtn.style.display = 'none';
                
                // Reset v·ªÅ tab "All"
                if (categoryTabs.length > 0) {
                    categoryTabs.forEach(t => t.classList.remove('active'));
                    categoryTabs[0].classList.add('active');
                    currentCategory = '';
                }
                
                // Reset sort
                if (priceSort) {
                    priceSort.value = '';
                    currentSort = '';
                }
                
                updateUrlParams();
                loadProducts();
            });
        }
        
        // Hi·ªÉn th·ªã n√∫t clear khi c√≥ n·ªôi dung
        if (searchInput && clearBtn) {
            searchInput.addEventListener('input', function() {
                clearBtn.style.display = this.value ? 'block' : 'none';
            });
        }
        
        // ===== 7. LOAD TRANG ƒê·∫¶U TI√äN HO·∫∂C T·ª™ URL =====
        function initializeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // L·∫•y search t·ª´ URL
            if (urlParams.has('search')) {
                currentSearch = urlParams.get('search');
                if (searchInput) {
                    searchInput.value = currentSearch;
                    if (clearBtn) clearBtn.style.display = 'block';
                }
            }
            
            // L·∫•y category t·ª´ URL v√† active tab t∆∞∆°ng ·ª©ng
            if (urlParams.has('category')) {
                currentCategory = urlParams.get('category');
                const targetTab = document.querySelector(`.category-tab[data-category="${currentCategory}"]`);
                if (targetTab) {
                    categoryTabs.forEach(t => t.classList.remove('active'));
                    targetTab.classList.add('active');
                }
            } else {
                // N·∫øu kh√¥ng c√≥ category trong URL, active tab "All"
                const allTab = document.querySelector('.category-tab[data-category=""]');
                if (allTab) {
                    categoryTabs.forEach(t => t.classList.remove('active'));
                    allTab.classList.add('active');
                    currentCategory = '';
                }
            }
            
            // L·∫•y sort t·ª´ URL
            if (urlParams.has('sort')) {
                currentSort = urlParams.get('sort');
                if (priceSort) priceSort.value = currentSort;
            }
            
            // Load s·∫£n ph·∫©m ƒë·∫ßu ti√™n
            loadProducts();
        }
        
        // Kh·ªüi t·∫°o t·ª´ URL
        initializeFromUrl();
        
        // ===== 8. X·ª¨ L√ù N√öT BACK/FORWARD =====
        window.addEventListener('popstate', function() {
            initializeFromUrl();
        });
    });
</script>
</body>
</html>